<!doctype html><html lang=en class=no-js> <head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=x-ua-compatible content="ie=edge"><meta name=description content="My second brain"><link href=https://lyz-code.github.io/blue-book/coding/python/sqlalchemy/ rel=canonical><meta name=author content=Lyz><meta name=lang:clipboard.copy content="Copy to clipboard"><meta name=lang:clipboard.copied content="Copied to clipboard"><meta name=lang:search.language content=en><meta name=lang:search.pipeline.stopwords content=True><meta name=lang:search.pipeline.trimmer content=True><meta name=lang:search.result.none content="No matching documents"><meta name=lang:search.result.one content="1 matching document"><meta name=lang:search.result.other content="# matching documents"><meta name=lang:search.tokenizer content=[\s\-]+><link rel="shortcut icon" href=../../../assets/images/favicon.png><meta name=generator content="mkdocs-1.1, mkdocs-material-4.6.3"><title>SQLAlchemy</title><link rel=stylesheet href=../../../assets/stylesheets/application.adb8469c.css><link rel=stylesheet href=../../../assets/stylesheets/application-palette.a8b3c06d.css><meta name=theme-color content=#546e7a><script src=../../../assets/javascripts/modernizr.86422ebf.js></script><link href=https://fonts.gstatic.com rel=preconnect crossorigin><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback"><style>body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}</style><link rel=stylesheet href=../../../assets/fonts/material-icons.css><link rel=stylesheet href=../../../stylesheets/extra.css><link rel=stylesheet href=../../../stylesheets/links.css></head> <body dir=ltr data-md-color-primary=blue-grey data-md-color-accent=light-blue> <svg class=md-svg> <defs> <svg xmlns=http://www.w3.org/2000/svg width=416 height=448 viewbox="0 0 416 448" id=__github><path fill=currentColor d="M160 304q0 10-3.125 20.5t-10.75 19T128 352t-18.125-8.5-10.75-19T96 304t3.125-20.5 10.75-19T128 256t18.125 8.5 10.75 19T160 304zm160 0q0 10-3.125 20.5t-10.75 19T288 352t-18.125-8.5-10.75-19T256 304t3.125-20.5 10.75-19T288 256t18.125 8.5 10.75 19T320 304zm40 0q0-30-17.25-51T296 232q-10.25 0-48.75 5.25Q229.5 240 208 240t-39.25-2.75Q130.75 232 120 232q-29.5 0-46.75 21T56 304q0 22 8 38.375t20.25 25.75 30.5 15 35 7.375 37.25 1.75h42q20.5 0 37.25-1.75t35-7.375 30.5-15 20.25-25.75T360 304zm56-44q0 51.75-15.25 82.75-9.5 19.25-26.375 33.25t-35.25 21.5-42.5 11.875-42.875 5.5T212 416q-19.5 0-35.5-.75t-36.875-3.125-38.125-7.5-34.25-12.875T37 371.5t-21.5-28.75Q0 312 0 260q0-59.25 34-99-6.75-20.5-6.75-42.5 0-29 12.75-54.5 27 0 47.5 9.875t47.25 30.875Q171.5 96 212 96q37 0 70 8 26.25-20.5 46.75-30.25T376 64q12.75 25.5 12.75 54.5 0 21.75-6.75 42 34 40 34 99.5z"/></svg> </defs> </svg> <input class=md-toggle data-md-toggle=drawer type=checkbox id=__drawer autocomplete=off> <input class=md-toggle data-md-toggle=search type=checkbox id=__search autocomplete=off> <label class=md-overlay data-md-component=overlay for=__drawer></label> <a href=#creating-an-sql-schema tabindex=0 class=md-skip> Skip to content </a> <header class=md-header data-md-component=header> <nav class="md-header-nav md-grid"> <div class=md-flex> <div class="md-flex__cell md-flex__cell--shrink"> <a href=https://lyz-code.github.io/blue-book title="The Blue Book" aria-label="The Blue Book" class="md-header-nav__button md-logo"> <img alt=logo src=../../../images/logo.bmp width=24 height=24> </a> </div> <div class="md-flex__cell md-flex__cell--shrink"> <label class="md-icon md-icon--menu md-header-nav__button" for=__drawer></label> </div> <div class="md-flex__cell md-flex__cell--stretch"> <div class="md-flex__ellipsis md-header-nav__title" data-md-component=title> <span class=md-header-nav__topic> The Blue Book </span> <span class=md-header-nav__topic> SQLAlchemy </span> </div> </div> <div class="md-flex__cell md-flex__cell--shrink"> <label class="md-icon md-icon--search md-header-nav__button" for=__search></label> <div class=md-search data-md-component=search role=dialog> <label class=md-search__overlay for=__search></label> <div class=md-search__inner role=search> <form class=md-search__form name=search> <input type=text class=md-search__input aria-label=search name=query placeholder=Search autocapitalize=off autocorrect=off autocomplete=off spellcheck=false data-md-component=query data-md-state=active> <label class="md-icon md-search__icon" for=__search></label> <button type=reset class="md-icon md-search__icon" data-md-component=reset tabindex=-1> &#xE5CD; </button> </form> <div class=md-search__output> <div class=md-search__scrollwrap data-md-scrollfix> <div class=md-search-result data-md-component=result> <div class=md-search-result__meta> Type to start searching </div> <ol class=md-search-result__list></ol> </div> </div> </div> </div> </div> </div> <div class="md-flex__cell md-flex__cell--shrink"> <div class=md-header-nav__source> <a href=https://github.com/lyz-code/blue-book/ title="Go to repository" class=md-source data-md-source=github> <div class=md-source__icon> <svg viewbox="0 0 24 24" width=24 height=24> <use xlink:href=#__github width=24 height=24></use> </svg> </div> <div class=md-source__repository> lyz-code/blue-book </div> </a> </div> </div> </div> </nav> </header> <div class=md-container> <main class=md-main role=main> <div class="md-main__inner md-grid" data-md-component=container> <div class="md-sidebar md-sidebar--primary" data-md-component=navigation> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--primary" data-md-level=0> <label class="md-nav__title md-nav__title--site" for=__drawer> <a href=https://lyz-code.github.io/blue-book title="The Blue Book" class="md-nav__button md-logo"> <img alt=logo src=../../../images/logo.bmp width=48 height=48> </a> The Blue Book </label> <div class=md-nav__source> <a href=https://github.com/lyz-code/blue-book/ title="Go to repository" class=md-source data-md-source=github> <div class=md-source__icon> <svg viewbox="0 0 24 24" width=24 height=24> <use xlink:href=#__github width=24 height=24></use> </svg> </div> <div class=md-source__repository> lyz-code/blue-book </div> </a> </div> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../.. title=Introduction class=md-nav__link> Introduction </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-2 type=checkbox id=nav-2> <label class=md-nav__link for=nav-2> Meta </label> <nav class=md-nav data-md-component=collapsible data-md-level=1> <label class=md-nav__title for=nav-2> Meta </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../meta/meta/ title=Meta class=md-nav__link> Meta </a> </li> <li class=md-nav__item> <a href=../../../projects/projects/ title=Projects class=md-nav__link> Projects </a> </li> <li class=md-nav__item> <a href=../../../wish_list/ title="Wish list" class=md-nav__link> Wish list </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-3 type=checkbox id=nav-3> <label class=md-nav__link for=nav-3> Life Automation </label> <nav class=md-nav data-md-component=collapsible data-md-level=1> <label class=md-nav__title for=nav-3> Life Automation </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../life_automation/life_automation/ title="Life Automation" class=md-nav__link> Life Automation </a> </li> <li class=md-nav__item> <a href=../../../life_automation/week_automation/ title="Week Automation" class=md-nav__link> Week Automation </a> </li> <li class=md-nav__item> <a href=../../../life_automation/vim_automation/ title="Vim Automation" class=md-nav__link> Vim Automation </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-4 type=checkbox id=nav-4> <label class=md-nav__link for=nav-4> DevOps </label> <nav class=md-nav data-md-component=collapsible data-md-level=1> <label class=md-nav__title for=nav-4> DevOps </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../devops/devops/ title=DevOps class=md-nav__link> DevOps </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-4-2 type=checkbox id=nav-4-2> <label class=md-nav__link for=nav-4-2> Architecture </label> <nav class=md-nav data-md-component=collapsible data-md-level=2> <label class=md-nav__title for=nav-4-2> Architecture </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../architecture/microservices/ title=Microservices class=md-nav__link> Microservices </a> </li> <li class=md-nav__item> <a href=../../../architecture/restful_apis/ title="Restful APIS" class=md-nav__link> Restful APIS </a> </li> <li class=md-nav__item> <a href=../../../architecture/redis/ title=Redis class=md-nav__link> Redis </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-4-3 type=checkbox id=nav-4-3> <label class=md-nav__link for=nav-4-3> Kubernetes </label> <nav class=md-nav data-md-component=collapsible data-md-level=2> <label class=md-nav__title for=nav-4-3> Kubernetes </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../devops/kubernetes/kubernetes/ title=Kubernetes class=md-nav__link> Kubernetes </a> </li> <li class=md-nav__item> <a href=../../../devops/kubernetes/kubernetes_architecture/ title=Architecture class=md-nav__link> Architecture </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-4-3-3 type=checkbox id=nav-4-3-3> <label class=md-nav__link for=nav-4-3-3> Resources </label> <nav class=md-nav data-md-component=collapsible data-md-level=3> <label class=md-nav__title for=nav-4-3-3> Resources </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../devops/kubernetes/kubernetes_namespaces/ title=Namespaces class=md-nav__link> Namespaces </a> </li> <li class=md-nav__item> <a href=../../../devops/kubernetes/kubernetes_pods/ title=Pods class=md-nav__link> Pods </a> </li> <li class=md-nav__item> <a href=../../../devops/kubernetes/kubernetes_replicasets/ title=ReplicaSets class=md-nav__link> ReplicaSets </a> </li> <li class=md-nav__item> <a href=../../../devops/kubernetes/kubernetes_deployments/ title=Deployments class=md-nav__link> Deployments </a> </li> <li class=md-nav__item> <a href=../../../devops/kubernetes/kubernetes_hpa/ title="Horizontal Pod Autoscaling" class=md-nav__link> Horizontal Pod Autoscaling </a> </li> <li class=md-nav__item> <a href=../../../devops/kubernetes/kubernetes_volumes/ title=Volumes class=md-nav__link> Volumes </a> </li> <li class=md-nav__item> <a href=../../../devops/kubernetes/kubernetes_services/ title=Services class=md-nav__link> Services </a> </li> <li class=md-nav__item> <a href=../../../devops/kubernetes/kubernetes_labels/ title=Labels class=md-nav__link> Labels </a> </li> <li class=md-nav__item> <a href=../../../devops/kubernetes/kubernetes_annotations/ title=Annotations class=md-nav__link> Annotations </a> </li> <li class=md-nav__item> <a href=../../../devops/kubernetes/kubernetes_ingress/ title=Ingress class=md-nav__link> Ingress </a> </li> <li class=md-nav__item> <a href=../../../devops/kubernetes/kubernetes_operators/ title=Operators class=md-nav__link> Operators </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-4-3-4 type=checkbox id=nav-4-3-4> <label class=md-nav__link for=nav-4-3-4> Kubectl </label> <nav class=md-nav data-md-component=collapsible data-md-level=3> <label class=md-nav__title for=nav-4-3-4> Kubectl </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../devops/kubectl/kubectl/ title=Kubectl class=md-nav__link> Kubectl </a> </li> <li class=md-nav__item> <a href=../../../devops/kubectl/kubectl_installation/ title="Kubectl Installation" class=md-nav__link> Kubectl Installation </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-4-3-5 type=checkbox id=nav-4-3-5> <label class=md-nav__link for=nav-4-3-5> Additional Components </label> <nav class=md-nav data-md-component=collapsible data-md-level=3> <label class=md-nav__title for=nav-4-3-5> Additional Components </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../devops/kubernetes/kubernetes_metric_server/ title="Metrics Server" class=md-nav__link> Metrics Server </a> </li> <li class=md-nav__item> <a href=../../../devops/kubernetes/kubernetes_ingress_controller/ title="Ingress Controller" class=md-nav__link> Ingress Controller </a> </li> <li class=md-nav__item> <a href=../../../devops/kubernetes/kubernetes_external_dns/ title="External DNS" class=md-nav__link> External DNS </a> </li> <li class=md-nav__item> <a href=../../../devops/kubernetes/kubernetes_cluster_autoscaler/ title="Cluster Autoscaler" class=md-nav__link> Cluster Autoscaler </a> </li> <li class=md-nav__item> <a href=../../../devops/kubernetes/kubernetes_dashboard/ title=Dashboard class=md-nav__link> Dashboard </a> </li> <li class=md-nav__item> <a href=../../../devops/kubernetes/kubernetes_storage_driver/ title="Storage Driver" class=md-nav__link> Storage Driver </a> </li> <li class=md-nav__item> <a href=../../../devops/kubernetes/kubernetes_vertical_pod_autoscaler/ title="Vertical Pod Autoscaler" class=md-nav__link> Vertical Pod Autoscaler </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../../../devops/kubernetes/kubernetes_networking/ title=Networking class=md-nav__link> Networking </a> </li> <li class=md-nav__item> <a href=../../../devops/kubernetes/kubernetes_tools/ title=Tools class=md-nav__link> Tools </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-4-4 type=checkbox id=nav-4-4> <label class=md-nav__link for=nav-4-4> Helm </label> <nav class=md-nav data-md-component=collapsible data-md-level=2> <label class=md-nav__title for=nav-4-4> Helm </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../devops/helm/helm/ title=Helm class=md-nav__link> Helm </a> </li> <li class=md-nav__item> <a href=../../../devops/helm/helm_installation/ title="Helm Installation" class=md-nav__link> Helm Installation </a> </li> <li class=md-nav__item> <a href=../../../devops/helm/helm_commands/ title="Helm Commands" class=md-nav__link> Helm Commands </a> </li> <li class=md-nav__item> <a href=../../../devops/helm/helm_secrets/ title="Helm Secrets" class=md-nav__link> Helm Secrets </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../../../devops/helmfile/ title=Helmfile class=md-nav__link> Helmfile </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-4-6 type=checkbox id=nav-4-6> <label class=md-nav__link for=nav-4-6> Prometheus </label> <nav class=md-nav data-md-component=collapsible data-md-level=2> <label class=md-nav__title for=nav-4-6> Prometheus </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../devops/prometheus/prometheus/ title=Prometheus class=md-nav__link> Prometheus </a> </li> <li class=md-nav__item> <a href=../../../devops/prometheus/prometheus_architecture/ title=Architecture class=md-nav__link> Architecture </a> </li> <li class=md-nav__item> <a href=../../../devops/prometheus/prometheus_operator/ title="Prometheus Operator" class=md-nav__link> Prometheus Operator </a> </li> <li class=md-nav__item> <a href=../../../devops/prometheus/prometheus_installation/ title="Prometheus Install" class=md-nav__link> Prometheus Install </a> </li> <li class=md-nav__item> <a href=../../../devops/prometheus/alertmanager/ title=AlertManager class=md-nav__link> AlertManager </a> </li> <li class=md-nav__item> <a href=../../../devops/prometheus/blackbox_exporter/ title="Blackbox Exporter" class=md-nav__link> Blackbox Exporter </a> </li> <li class=md-nav__item> <a href=../../../devops/prometheus/node_exporter/ title="Node Exporter" class=md-nav__link> Node Exporter </a> </li> <li class=md-nav__item> <a href=../../../devops/prometheus/prometheus_troubleshooting/ title="Prometheus Troubleshooting" class=md-nav__link> Prometheus Troubleshooting </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-4-7 type=checkbox id=nav-4-7> <label class=md-nav__link for=nav-4-7> Linux </label> <nav class=md-nav data-md-component=collapsible data-md-level=2> <label class=md-nav__title for=nav-4-7> Linux </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../linux/brew/ title=brew class=md-nav__link> brew </a> </li> <li class=md-nav__item> <a href=../../../linux/fail2ban/ title=fail2ban class=md-nav__link> fail2ban </a> </li> <li class=md-nav__item> <a href=../../../linux/google_chrome/ title="google chrome" class=md-nav__link> google chrome </a> </li> <li class=md-nav__item> <a href=../../../linux/hypothesis/ title=hypothesis class=md-nav__link> hypothesis </a> </li> <li class=md-nav__item> <a href=../../../linux/luks/luks/ title=LUKS class=md-nav__link> LUKS </a> </li> <li class=md-nav__item> <a href=../../../linux/mkdocs/ title=mkdocs class=md-nav__link> mkdocs </a> </li> <li class=md-nav__item> <a href=../../../linux/nodejs/ title=nodejs class=md-nav__link> nodejs </a> </li> <li class=md-nav__item> <a href=../../../linux/rm/ title=rm class=md-nav__link> rm </a> </li> <li class=md-nav__item> <a href=../../../linux/syncthing/ title=Syncthing class=md-nav__link> Syncthing </a> </li> <li class=md-nav__item> <a href=../../../linux/zip/ title=zip class=md-nav__link> zip </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-4-8 type=checkbox id=nav-4-8> <label class=md-nav__link for=nav-4-8> AWS </label> <nav class=md-nav data-md-component=collapsible data-md-level=2> <label class=md-nav__title for=nav-4-8> AWS </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../devops/aws/aws/ title=AWS class=md-nav__link> AWS </a> </li> <li class=md-nav__item> <a href=../../../devops/aws/security_groups/ title="Security groups workflow" class=md-nav__link> Security groups workflow </a> </li> <li class=md-nav__item> <a href=../../../devops/aws/eks/ title=EKS class=md-nav__link> EKS </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-4-8-4 type=checkbox id=nav-4-8-4> <label class=md-nav__link for=nav-4-8-4> IAM </label> <nav class=md-nav data-md-component=collapsible data-md-level=3> <label class=md-nav__title for=nav-4-8-4> IAM </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../devops/aws/iam/iam/ title=IAM class=md-nav__link> IAM </a> </li> <li class=md-nav__item> <a href=../../../devops/aws/iam/iam_commands/ title="IAM Commands" class=md-nav__link> IAM Commands </a> </li> <li class=md-nav__item> <a href=../../../devops/aws/iam/iam_debug/ title="IAM Debugging" class=md-nav__link> IAM Debugging </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../../../devops/aws/s3/ title=S3 class=md-nav__link> S3 </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-4-9 type=checkbox id=nav-4-9> <label class=md-nav__link for=nav-4-9> API Management </label> <nav class=md-nav data-md-component=collapsible data-md-level=2> <label class=md-nav__title for=nav-4-9> API Management </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../devops/api_management/ title="API Management" class=md-nav__link> API Management </a> </li> <li class=md-nav__item> <a href=../../../devops/kong/kong/ title=Kong class=md-nav__link> Kong </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--active md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-5 type=checkbox id=nav-5 checked> <label class=md-nav__link for=nav-5> Coding </label> <nav class=md-nav data-md-component=collapsible data-md-level=1> <label class=md-nav__title for=nav-5> Coding </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--active md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-5-1 type=checkbox id=nav-5-1 checked> <label class=md-nav__link for=nav-5-1> Python </label> <nav class=md-nav data-md-component=collapsible data-md-level=2> <label class=md-nav__title for=nav-5-1> Python </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-5-1-1 type=checkbox id=nav-5-1-1> <label class=md-nav__link for=nav-5-1-1> Project Template </label> <nav class=md-nav data-md-component=collapsible data-md-level=3> <label class=md-nav__title for=nav-5-1-1> Project Template </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../python_project_template/ title="Project Template" class=md-nav__link> Project Template </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-5-1-1-2 type=checkbox id=nav-5-1-1-2> <label class=md-nav__link for=nav-5-1-1-2> Command-line Project Template </label> <nav class=md-nav data-md-component=collapsible data-md-level=4> <label class=md-nav__title for=nav-5-1-1-2> Command-line Project Template </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../python_project_template/python_cli_template/ title="Command-line Project Template" class=md-nav__link> Command-line Project Template </a> </li> <li class=md-nav__item> <a href=../python_project_template/python_sqlalchemy_without_flask/ title="Configure SQLAlchemy for projects without flask" class=md-nav__link> Configure SQLAlchemy for projects without flask </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../python_project_template/python_flask_template/ title="Flask Project Template" class=md-nav__link> Flask Project Template </a> </li> <li class=md-nav__item> <a href=../python_project_template/python_microservices_template/ title="Microservices Project Template" class=md-nav__link> Microservices Project Template </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-5-1-1-5 type=checkbox id=nav-5-1-1-5> <label class=md-nav__link for=nav-5-1-1-5> Common configurations </label> <nav class=md-nav data-md-component=collapsible data-md-level=4> <label class=md-nav__title for=nav-5-1-1-5> Common configurations </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../python_project_template/python_docs/ title="Create the documentation repository" class=md-nav__link> Create the documentation repository </a> </li> <li class=md-nav__item> <a href=../python_ci/ title="Continuous integration pipelines" class=md-nav__link> Continuous integration pipelines </a> </li> <li class=md-nav__item> <a href=../python_config_yaml/ title="Load config from YAML" class=md-nav__link> Load config from YAML </a> </li> <li class=md-nav__item> <a href=../python_project_template/python_sqlalchemy_mariadb/ title="Configure SQLAlchemy to use the MariaDB/Mysql backend" class=md-nav__link> Configure SQLAlchemy to use the MariaDB/Mysql backend </a> </li> <li class=md-nav__item> <a href=../python_project_template/python_docker/ title="Configure Docker and Docker compose to host the application" class=md-nav__link> Configure Docker and Docker compose to host the application </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../alembic/ title=Alembic class=md-nav__link> Alembic </a> </li> <li class=md-nav__item> <a href=../factoryboy/ title=FactoryBoy class=md-nav__link> FactoryBoy </a> </li> <li class=md-nav__item> <a href=../faker/ title=Faker class=md-nav__link> Faker </a> </li> <li class=md-nav__item> <a href=../flask/ title=Flask class=md-nav__link> Flask </a> </li> <li class=md-nav__item> <a href=../feedparser/ title=Feedparser class=md-nav__link> Feedparser </a> </li> <li class=md-nav__item> <a href=../pandas/ title=Pandas class=md-nav__link> Pandas </a> </li> <li class=md-nav__item> <a href=../plotly/ title=Plotly class=md-nav__link> Plotly </a> </li> <li class=md-nav__item> <a href=../pytest/ title=Pytest class=md-nav__link> Pytest </a> </li> <li class=md-nav__item> <a href=../ruamel_yaml/ title="Ruamel YAML" class=md-nav__link> Ruamel YAML </a> </li> <li class="md-nav__item md-nav__item--active"> <input class="md-toggle md-nav__toggle" data-md-toggle=toc type=checkbox id=__toc> <label class="md-nav__link md-nav__link--active" for=__toc> SQLAlchemy </label> <a href=./ title=SQLAlchemy class="md-nav__link md-nav__link--active"> SQLAlchemy </a> <nav class="md-nav md-nav--secondary"> <label class=md-nav__title for=__toc>Table of contents</label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=#creating-an-sql-schema class=md-nav__link> Creating an SQL Schema </a> <nav class=md-nav> <ul class=md-nav__list> <li class=md-nav__item> <a href=#creating-tables class=md-nav__link> Creating Tables </a> </li> <li class=md-nav__item> <a href=#creating-relationships class=md-nav__link> Creating relationships </a> <nav class=md-nav> <ul class=md-nav__list> <li class=md-nav__item> <a href=#joined-table-inheritance class=md-nav__link> Joined table inheritance </a> </li> <li class=md-nav__item> <a href=#one-to-many class=md-nav__link> One to many </a> <nav class=md-nav> <ul class=md-nav__list> <li class=md-nav__item> <a href=#self-referenced-one-to-many class=md-nav__link> Self referenced one to many </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#many-to-many class=md-nav__link> Many to many </a> <nav class=md-nav> <ul class=md-nav__list> <li class=md-nav__item> <a href=#self-referenced-many-to-many class=md-nav__link> Self referenced many to many </a> </li> </ul> </nav> </li> </ul> </nav> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#testing-sqlalchemy-code class=md-nav__link> Testing SQLAlchemy Code </a> </li> <li class=md-nav__item> <a href=#exporting-database-to-json class=md-nav__link> Exporting database to json </a> </li> <li class=md-nav__item> <a href=#cloning-an-sqlalchemy-object class=md-nav__link> Cloning an SQLAlchemy object </a> </li> <li class=md-nav__item> <a href=#references class=md-nav__link> References </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../redis-py/ title=Redis-py class=md-nav__link> Redis-py </a> </li> <li class=md-nav__item> <a href=../requests_mock/ title=Requests-mock class=md-nav__link> Requests-mock </a> </li> <li class=md-nav__item> <a href=../rq/ title=Rq class=md-nav__link> Rq </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-5-2 type=checkbox id=nav-5-2> <label class=md-nav__link for=nav-5-2> Javascript </label> <nav class=md-nav data-md-component=collapsible data-md-level=2> <label class=md-nav__title for=nav-5-2> Javascript </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../javascript/javascript/ title=Javascript class=md-nav__link> Javascript </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-5-3 type=checkbox id=nav-5-3> <label class=md-nav__link for=nav-5-3> React </label> <nav class=md-nav data-md-component=collapsible data-md-level=2> <label class=md-nav__title for=nav-5-3> React </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../react/react/ title=React class=md-nav__link> React </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../../yaml/yaml/ title=YAML class=md-nav__link> YAML </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-6 type=checkbox id=nav-6> <label class=md-nav__link for=nav-6> Data Analysis </label> <nav class=md-nav data-md-component=collapsible data-md-level=1> <label class=md-nav__title for=nav-6> Data Analysis </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-6-1 type=checkbox id=nav-6-1> <label class=md-nav__link for=nav-6-1> Recommender Systems </label> <nav class=md-nav data-md-component=collapsible data-md-level=2> <label class=md-nav__title for=nav-6-1> Recommender Systems </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../data_analysis/recommender_systems/recommender_systems/ title="Recommender Systems" class=md-nav__link> Recommender Systems </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-7 type=checkbox id=nav-7> <label class=md-nav__link for=nav-7> Drawing </label> <nav class=md-nav data-md-component=collapsible data-md-level=1> <label class=md-nav__title for=nav-7> Drawing </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../drawing/drawing/ title=Drawing class=md-nav__link> Drawing </a> </li> <li class=md-nav__item> <a href=../../../drawing/exercise_pool/ title="Exercise Pool" class=md-nav__link> Exercise Pool </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../../../emojis/ title=Emojis class=md-nav__link> Emojis </a> </li> <li class=md-nav__item> <a href=../../../contact/ title=Contact class=md-nav__link> Contact </a> </li> </ul> </nav> </div> </div> </div> <div class="md-sidebar md-sidebar--secondary" data-md-component=toc> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--secondary"> <label class=md-nav__title for=__toc>Table of contents</label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=#creating-an-sql-schema class=md-nav__link> Creating an SQL Schema </a> <nav class=md-nav> <ul class=md-nav__list> <li class=md-nav__item> <a href=#creating-tables class=md-nav__link> Creating Tables </a> </li> <li class=md-nav__item> <a href=#creating-relationships class=md-nav__link> Creating relationships </a> <nav class=md-nav> <ul class=md-nav__list> <li class=md-nav__item> <a href=#joined-table-inheritance class=md-nav__link> Joined table inheritance </a> </li> <li class=md-nav__item> <a href=#one-to-many class=md-nav__link> One to many </a> <nav class=md-nav> <ul class=md-nav__list> <li class=md-nav__item> <a href=#self-referenced-one-to-many class=md-nav__link> Self referenced one to many </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#many-to-many class=md-nav__link> Many to many </a> <nav class=md-nav> <ul class=md-nav__list> <li class=md-nav__item> <a href=#self-referenced-many-to-many class=md-nav__link> Self referenced many to many </a> </li> </ul> </nav> </li> </ul> </nav> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#testing-sqlalchemy-code class=md-nav__link> Testing SQLAlchemy Code </a> </li> <li class=md-nav__item> <a href=#exporting-database-to-json class=md-nav__link> Exporting database to json </a> </li> <li class=md-nav__item> <a href=#cloning-an-sqlalchemy-object class=md-nav__link> Cloning an SQLAlchemy object </a> </li> <li class=md-nav__item> <a href=#references class=md-nav__link> References </a> </li> </ul> </nav> </div> </div> </div> <div class=md-content> <article class="md-content__inner md-typeset"> <a href=https://github.com/lyz-code/blue-book/edit/master/docs/coding/python/sqlalchemy.md title="Edit this page" class="md-icon md-content__icon">&#xE3C9;</a> <h1>SQLAlchemy</h1> <p><a href=https://www.sqlalchemy.org/ >SQLAlchemy</a> is the Python SQL toolkit and Object Relational Mapper that gives application developers the full power and flexibility of SQL.</p> <h2 id=creating-an-sql-schema>Creating an SQL Schema<a class=headerlink href=#creating-an-sql-schema title="Permanent link">&para;</a></h2> <p>First of all it's important to create a diagram with the database structure, it will help you in the design and it's a great improvement of the project's documentation. I usually use <a href=https://github.com/ondras/wwwsqldesigner>ondras wwwsqldesigner</a> through his <a href=https://ondras.zarovi.cz/sql/demo/ >demo</a>, as it's easy to use and it's possible to save the data in your repository in an xml file.</p> <p>I assume you've already <a href=../python_project_template/#set-up-sqlalchemy-for-projects-without-flask>set up your project to support sqlalchemy</a> in your project. If not, do so before moving forward.</p> <h3 id=creating-tables>Creating Tables<a class=headerlink href=#creating-tables title="Permanent link">&para;</a></h3> <p>If you simply want to create a table of association without any parameters, such as with a many to many relationship association table, use this type of object.</p> <div class=highlight><pre><span></span><code><span class=k>class</span> <span class=nc>User</span><span class=p>(</span><span class=n>Base</span><span class=p>):</span>
    <span class=sd>&quot;&quot;&quot;</span>
<span class=sd>    Class to define the User model.</span>
<span class=sd>    &quot;&quot;&quot;</span>
    <span class=n>__tablename__</span> <span class=o>=</span> <span class=s1>&#39;user&#39;</span>
    <span class=nb>id</span> <span class=o>=</span> <span class=n>Column</span><span class=p>(</span><span class=n>Integer</span><span class=p>,</span> <span class=n>primary_key</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span> <span class=n>doc</span><span class=o>=</span><span class=s1>&#39;User ID&#39;</span><span class=p>)</span>
    <span class=n>name</span> <span class=o>=</span> <span class=n>Column</span><span class=p>(</span><span class=n>String</span><span class=p>,</span> <span class=n>doc</span><span class=o>=</span><span class=s1>&#39;User name&#39;</span><span class=p>)</span>

    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span>
        <span class=bp>self</span><span class=p>,</span>
        <span class=nb>id</span><span class=p>,</span>
        <span class=n>name</span><span class=o>=</span><span class=kc>None</span><span class=p>,</span>
    <span class=p>):</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>id</span> <span class=o>=</span> <span class=nb>id</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>name</span> <span class=o>=</span> <span class=n>name</span>
</code></pre></div> <p>There are <a href=https://docs.sqlalchemy.org/en/13/core/type_basics.html>different types</a> of fields to add to a table:</p> <ul> <li>Boolean: <code>is_true = Column(Boolean)</code>.</li> <li>Datetime: <code>created_date = Column(DateTime, doc='Date of creation')</code>.</li> <li>Float: <code>score = Column(Float)</code></li> <li>Integer: <code>id = Column(Integer, primary_key=True, doc='Source ID')</code>.</li> <li>String: <code>title = Column(String)</code>.</li> <li>Text: <code>long_text = Column(Text)</code>.</li> </ul> <p>To make sure that a field can't contain <code>nulls</code> set the <code>nullable=False</code> attribute in the definition of the <code>Column</code>. If you want the contents to be unique use <code>unique=True</code>.</p> <p>If you want to use the Mysql driver of SQLAlchemy make sure to specify the length of the colums, for example <code>String(16)</code>. For reference this are the common lengths:</p> <ul> <li>url: 2083</li> <li>name: 64 (it occupies the same 2 and 255).</li> <li>email: 64 (it occupies the same 2 and 255).</li> <li>username: 64 (it occupies the same 2 and 255).</li> </ul> <h3 id=creating-relationships>Creating relationships<a class=headerlink href=#creating-relationships title="Permanent link">&para;</a></h3> <h4 id=joined-table-inheritance><a href=https://docs.sqlalchemy.org/en/13/orm/inheritance.html#joined-table-inheritance>Joined table inheritance</a><a class=headerlink href=#joined-table-inheritance title="Permanent link">&para;</a></h4> <p>In joined table inheritance, each class along a hierarchy of classes is represented by a distinct table. Querying for a particular subclass in the hierarchy will render as a <code>SQL JOIN</code> along all tables in its inheritance path. If the queried class is the base class, the default behavior is to include only the base table in a <code>SELECT</code> statement. In all cases, the ultimate class to instantiate for a given row is determined by a discriminator column or an expression that works against the base table. When a subclass is loaded only against a base table, resulting objects by default will have base attributes populated at first; attributes that are local to the subclass will lazy load when they are accessed.</p> <p>The base class in a joined inheritance hierarchy is configured with additional arguments that will refer to the polymorphic discriminator column as well as the identifier for the base class.</p> <div class=highlight><pre><span></span><code><span class=k>class</span> <span class=nc>Employee</span><span class=p>(</span><span class=n>Base</span><span class=p>):</span>
    <span class=n>__tablename__</span> <span class=o>=</span> <span class=s1>&#39;employee&#39;</span>
    <span class=nb>id</span> <span class=o>=</span> <span class=n>Column</span><span class=p>(</span><span class=n>Integer</span><span class=p>,</span> <span class=n>primary_key</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
    <span class=n>name</span> <span class=o>=</span> <span class=n>Column</span><span class=p>(</span><span class=n>String</span><span class=p>(</span><span class=mi>50</span><span class=p>))</span>
    <span class=nb>type</span> <span class=o>=</span> <span class=n>Column</span><span class=p>(</span><span class=n>String</span><span class=p>(</span><span class=mi>50</span><span class=p>))</span>

    <span class=n>__mapper_args__</span> <span class=o>=</span> <span class=p>{</span>
        <span class=s1>&#39;polymorphic_identity&#39;</span><span class=p>:</span> <span class=s1>&#39;employee&#39;</span><span class=p>,</span>
        <span class=s1>&#39;polymorphic_on&#39;</span><span class=p>:</span> <span class=nb>type</span>
    <span class=p>}</span>


<span class=k>class</span> <span class=nc>Engineer</span><span class=p>(</span><span class=n>Employee</span><span class=p>):</span>
    <span class=n>__tablename__</span> <span class=o>=</span> <span class=s1>&#39;engineer&#39;</span>
    <span class=nb>id</span> <span class=o>=</span> <span class=n>Column</span><span class=p>(</span><span class=n>Integer</span><span class=p>,</span> <span class=n>ForeignKey</span><span class=p>(</span><span class=s1>&#39;employee.id&#39;</span><span class=p>),</span> <span class=n>primary_key</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
    <span class=n>engineer_name</span> <span class=o>=</span> <span class=n>Column</span><span class=p>(</span><span class=n>String</span><span class=p>(</span><span class=mi>30</span><span class=p>))</span>

    <span class=n>__mapper_args__</span> <span class=o>=</span> <span class=p>{</span>
        <span class=s1>&#39;polymorphic_identity&#39;</span><span class=p>:</span> <span class=s1>&#39;engineer&#39;</span><span class=p>,</span>
    <span class=p>}</span>


<span class=k>class</span> <span class=nc>Manager</span><span class=p>(</span><span class=n>Employee</span><span class=p>):</span>
    <span class=n>__tablename__</span> <span class=o>=</span> <span class=s1>&#39;manager&#39;</span>
    <span class=nb>id</span> <span class=o>=</span> <span class=n>Column</span><span class=p>(</span><span class=n>Integer</span><span class=p>,</span> <span class=n>ForeignKey</span><span class=p>(</span><span class=s1>&#39;employee.id&#39;</span><span class=p>),</span> <span class=n>primary_key</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
    <span class=n>manager_name</span> <span class=o>=</span> <span class=n>Column</span><span class=p>(</span><span class=n>String</span><span class=p>(</span><span class=mi>30</span><span class=p>))</span>

    <span class=n>__mapper_args__</span> <span class=o>=</span> <span class=p>{</span>
        <span class=s1>&#39;polymorphic_identity&#39;</span><span class=p>:</span> <span class=s1>&#39;manager&#39;</span><span class=p>,</span>
    <span class=p>}</span>
</code></pre></div> <h4 id=one-to-many>One to many<a class=headerlink href=#one-to-many title="Permanent link">&para;</a></h4> <div class=highlight><pre><span></span><code><span class=kn>from</span> <span class=nn>sqlalchemy.orm</span> <span class=kn>import</span> <span class=n>relationship</span>


<span class=k>class</span> <span class=nc>User</span><span class=p>(</span><span class=n>db</span><span class=o>.</span><span class=n>Model</span><span class=p>):</span>
    <span class=n>__tablename__</span> <span class=o>=</span> <span class=s1>&#39;user&#39;</span>
    <span class=nb>id</span> <span class=o>=</span> <span class=n>Column</span><span class=p>(</span><span class=n>Integer</span><span class=p>,</span> <span class=n>primary_key</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
    <span class=n>posts</span> <span class=o>=</span> <span class=n>relationship</span><span class=p>(</span><span class=s1>&#39;Post&#39;</span><span class=p>,</span> <span class=n>back_populates</span><span class=o>=</span><span class=s1>&#39;user&#39;</span><span class=p>)</span>


<span class=k>class</span> <span class=nc>Post</span><span class=p>(</span><span class=n>db</span><span class=o>.</span><span class=n>Model</span><span class=p>):</span>
    <span class=nb>id</span> <span class=o>=</span> <span class=n>Column</span><span class=p>(</span><span class=n>Integer</span><span class=p>,</span> <span class=n>primary_key</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
    <span class=n>body</span> <span class=o>=</span> <span class=n>Column</span><span class=p>(</span><span class=n>String</span><span class=p>(</span><span class=mi>140</span><span class=p>))</span>
    <span class=n>user_id</span> <span class=o>=</span> <span class=n>Column</span><span class=p>(</span><span class=n>Integer</span><span class=p>,</span> <span class=n>ForeignKey</span><span class=p>(</span><span class=s1>&#39;user.id&#39;</span><span class=p>))</span>
    <span class=n>user</span> <span class=o>=</span> <span class=n>relationship</span><span class=p>(</span><span class=s1>&#39;User&#39;</span><span class=p>,</span> <span class=n>back_populates</span><span class=o>=</span><span class=s1>&#39;posts&#39;</span><span class=p>)</span>
</code></pre></div> <p>In the tests of the <code>Post</code> class, only check that the <code>user</code> attribute is present.</p> <p><a href=../factoryboy/ >Factoryboy</a> supports the creation of <a href="../factoryboy/#dependent_objects_direct foreignKey">Dependent objects direct ForeignKey</a>.</p> <h5 id=self-referenced-one-to-many>Self referenced one to many<a class=headerlink href=#self-referenced-one-to-many title="Permanent link">&para;</a></h5> <div class=highlight><pre><span></span><code><span class=k>class</span> <span class=nc>Task</span><span class=p>(</span><span class=n>Base</span><span class=p>):</span>
    <span class=n>__tablename__</span> <span class=o>=</span> <span class=s1>&#39;task&#39;</span>
    <span class=nb>id</span> <span class=o>=</span> <span class=n>Column</span><span class=p>(</span><span class=n>String</span><span class=p>,</span> <span class=n>primary_key</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span> <span class=n>doc</span><span class=o>=</span><span class=s1>&#39;fulid of creation&#39;</span><span class=p>)</span>

    <span class=n>parent_id</span> <span class=o>=</span> <span class=n>Column</span><span class=p>(</span><span class=n>String</span><span class=p>,</span> <span class=n>ForeignKey</span><span class=p>(</span><span class=s1>&#39;task.id&#39;</span><span class=p>))</span>
    <span class=n>parent</span> <span class=o>=</span> <span class=n>relationship</span><span class=p>(</span><span class=s1>&#39;Task&#39;</span><span class=p>,</span> <span class=n>remote_side</span><span class=o>=</span><span class=p>[</span><span class=nb>id</span><span class=p>],</span> <span class=n>backref</span><span class=o>=</span><span class=s1>&#39;children&#39;</span><span class=p>)</span>
</code></pre></div> <h4 id=many-to-many><a href=https://docs.sqlalchemy.org/en/13/orm/basic_relationships.html#many-to-many>Many to many</a><a class=headerlink href=#many-to-many title="Permanent link">&para;</a></h4> <div class=highlight><pre><span></span><code><span class=c1># Association tables</span>

<span class=n>source_has_category</span> <span class=o>=</span> <span class=n>Table</span><span class=p>(</span>
    <span class=s1>&#39;source_has_category&#39;</span><span class=p>,</span>
    <span class=n>Base</span><span class=o>.</span><span class=n>metadata</span><span class=p>,</span>
    <span class=n>Column</span><span class=p>(</span><span class=s1>&#39;source_id&#39;</span><span class=p>,</span> <span class=n>Integer</span><span class=p>,</span> <span class=n>ForeignKey</span><span class=p>(</span><span class=s1>&#39;source.id&#39;</span><span class=p>)),</span>
    <span class=n>Column</span><span class=p>(</span><span class=s1>&#39;category_id&#39;</span><span class=p>,</span> <span class=n>Integer</span><span class=p>,</span> <span class=n>ForeignKey</span><span class=p>(</span><span class=s1>&#39;category.id&#39;</span><span class=p>))</span>
<span class=p>)</span>

<span class=c1># Tables</span>


<span class=k>class</span> <span class=nc>Category</span><span class=p>(</span><span class=n>Base</span><span class=p>):</span>
    <span class=n>__tablename__</span> <span class=o>=</span> <span class=s1>&#39;category&#39;</span>
    <span class=nb>id</span> <span class=o>=</span> <span class=n>Column</span><span class=p>(</span><span class=n>String</span><span class=p>,</span> <span class=n>primary_key</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
    <span class=n>contents</span> <span class=o>=</span> <span class=n>relationship</span><span class=p>(</span>
        <span class=s1>&#39;Content&#39;</span><span class=p>,</span>
        <span class=n>back_populates</span><span class=o>=</span><span class=s1>&#39;categories&#39;</span><span class=p>,</span>
        <span class=n>secondary</span><span class=o>=</span><span class=n>source_has_category</span><span class=p>,</span>
    <span class=p>)</span>


<span class=k>class</span> <span class=nc>Content</span><span class=p>(</span><span class=n>Base</span><span class=p>):</span>
    <span class=n>__tablename__</span> <span class=o>=</span> <span class=s1>&#39;content&#39;</span>
    <span class=nb>id</span> <span class=o>=</span> <span class=n>Column</span><span class=p>(</span><span class=n>Integer</span><span class=p>,</span> <span class=n>primary_key</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span> <span class=n>doc</span><span class=o>=</span><span class=s1>&#39;Content ID&#39;</span><span class=p>)</span>
    <span class=n>categories</span> <span class=o>=</span> <span class=n>relationship</span><span class=p>(</span>
        <span class=s1>&#39;Category&#39;</span><span class=p>,</span>
        <span class=n>back_populates</span><span class=o>=</span><span class=s1>&#39;contents&#39;</span><span class=p>,</span>
        <span class=n>secondary</span><span class=o>=</span><span class=n>source_has_category</span><span class=p>,</span>
    <span class=p>)</span>
</code></pre></div> <h5 id=self-referenced-many-to-many>Self referenced many to many<a class=headerlink href=#self-referenced-many-to-many title="Permanent link">&para;</a></h5> <p>Using the <code>followers</code> table as an association table.</p> <p><div class=highlight><pre><span></span><code><span class=n>followers</span> <span class=o>=</span> <span class=n>db</span><span class=o>.</span><span class=n>Table</span><span class=p>(</span>
    <span class=s1>&#39;followers&#39;</span><span class=p>,</span>
    <span class=n>Base</span><span class=o>.</span><span class=n>metadata</span><span class=p>,</span>
    <span class=n>Column</span><span class=p>(</span><span class=s1>&#39;follower_id&#39;</span><span class=p>,</span> <span class=n>Integer</span><span class=p>,</span> <span class=n>ForeignKey</span><span class=p>(</span><span class=s1>&#39;user.id&#39;</span><span class=p>)),</span>
    <span class=n>Column</span><span class=p>(</span><span class=s1>&#39;followed_id&#39;</span><span class=p>,</span> <span class=n>Integer</span><span class=p>,</span> <span class=n>ForeignKey</span><span class=p>(</span><span class=s1>&#39;user.id&#39;</span><span class=p>)),</span>
<span class=p>)</span>


<span class=k>class</span> <span class=nc>User</span><span class=p>(</span><span class=n>Base</span><span class=p>):</span>
    <span class=n>__tablename__</span> <span class=o>=</span> <span class=s1>&#39;user&#39;</span>
    <span class=nb>id</span> <span class=o>=</span> <span class=n>Column</span><span class=p>(</span><span class=n>Integer</span><span class=p>,</span> <span class=n>primary_key</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
    <span class=n>followed</span> <span class=o>=</span> <span class=n>relationship</span><span class=p>(</span>
        <span class=s1>&#39;User&#39;</span><span class=p>,</span>
        <span class=n>secondary</span><span class=o>=</span><span class=n>followers</span><span class=p>,</span>
        <span class=n>primaryjoin</span><span class=o>=</span><span class=p>(</span><span class=n>followers</span><span class=o>.</span><span class=n>c</span><span class=o>.</span><span class=n>follower_id</span> <span class=o>==</span> <span class=nb>id</span><span class=p>),</span>
        <span class=n>secondaryjoin</span><span class=o>=</span><span class=p>(</span><span class=n>followers</span><span class=o>.</span><span class=n>c</span><span class=o>.</span><span class=n>followed_id</span> <span class=o>==</span> <span class=nb>id</span><span class=p>),</span>
        <span class=n>backref</span><span class=o>=</span><span class=n>db</span><span class=o>.</span><span class=n>backref</span><span class=p>(</span><span class=s1>&#39;followers&#39;</span><span class=p>,</span> <span class=n>lazy</span><span class=o>=</span><span class=s1>&#39;dynamic&#39;</span><span class=p>),</span>
        <span class=n>lazy</span><span class=o>=</span><span class=s1>&#39;dynamic&#39;</span><span class=p>,</span>
    <span class=p>)</span>
</code></pre></div> Links User instances to other User instances, so as a convention let's say that for a pair of users linked by this relationship, the left side user is following the right side user. The relationship definition is created as seen from the left side user with the name followed, because when this relationship is queried from the left side it will get the list of followed users (i.e those on the right side).</p> <ul> <li><code>User</code>: Is the right side entity of the relationship. Since this is a self-referential relationship, The same class must be used on both sides.</li> <li><code>secondary</code>: configures the association table that is used for this relationship.</li> <li><code>primaryjoin</code>: Indicates the condition that links the left side entity (the follower user) with the association table. The join condition for the left side of the relationship is the user id matching the <code>follower_id</code> field of the association table. The <code>followers.c.follower_id</code> expression references the <code>follower_id</code> column of the association table.</li> <li><code>secondaryjoin</code>: Indicates the condition that links the right side entity (the followed user) with the association table. This condition is similar to the one for <code>primaryjoin</code>.</li> <li><code>backref</code>: Defines how this relationship will be accessed from the right side entity. From the left side, the relationship is named <code>followed</code>, so from the right side, the name <code>followers</code> represent all the left side users that are linked to the target user in the right side. The additional <code>lazy</code> argument indicates the execution mode for this query. A mode of <code>dynamic</code> sets up the query not to run until specifically requested.</li> <li><code>lazy</code>: same as with <code>backref</code>, but this one applies to the left side query instead of the right side.</li> </ul> <h2 id=testing-sqlalchemy-code>Testing SQLAlchemy Code<a class=headerlink href=#testing-sqlalchemy-code title="Permanent link">&para;</a></h2> <p>The definition of the database can be tested, I usually use them to test that the attributes are loaded and that the <a href=../factoryboy/ >factory objects</a> work as expected. Several steps need to be set to make it work:</p> <ul> <li> <p>Create the <a href=../factoryboy/ >factory boy objects</a> in <code>tests/factories.py</code>.</p> </li> <li> <p>Configure the tests to use a temporal sqlite database in the <code>tests/conftest.py</code> file with the following contents (changing <code>{{ program_name }}</code>):</p> <div class=highlight><pre><span></span><code><span class=kn>from</span> <span class=nn>alembic.command</span> <span class=kn>import</span> <span class=n>upgrade</span>
<span class=kn>from</span> <span class=nn>alembic.config</span> <span class=kn>import</span> <span class=n>Config</span>
<span class=kn>from</span> <span class=nn>sqlalchemy.orm</span> <span class=kn>import</span> <span class=n>sessionmaker</span>

<span class=kn>import</span> <span class=nn>os</span>
<span class=kn>import</span> <span class=nn>pytest</span>
<span class=kn>import</span> <span class=nn>tempfile</span>

<span class=n>temp_ddbb</span> <span class=o>=</span> <span class=n>tempfile</span><span class=o>.</span><span class=n>mkstemp</span><span class=p>()[</span><span class=mi>1</span><span class=p>]</span>

<span class=n>os</span><span class=o>.</span><span class=n>environ</span><span class=p>[</span><span class=s1>&#39;{{ program_name }} _DATABASE_URL&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=s1>&#39;sqlite:///</span><span class=si>{}</span><span class=s1>&#39;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=n>temp_ddbb</span><span class=p>)</span>

<span class=c1># It needs to be after the environmental variable</span>
<span class=kn>from</span> <span class=p>{{</span> <span class=n>program_name</span> <span class=p>}}</span><span class=o>.</span><span class=n>models</span> <span class=kn>import</span> <span class=nn>engine</span>
<span class=kn>from</span> <span class=nn>tests</span> <span class=kn>import</span> <span class=n>factories</span>


<span class=nd>@pytest</span><span class=o>.</span><span class=n>fixture</span><span class=p>(</span><span class=n>scope</span><span class=o>=</span><span class=s1>&#39;module&#39;</span><span class=p>)</span>
<span class=k>def</span> <span class=nf>connection</span><span class=p>():</span>
    <span class=sd>&#39;&#39;&#39;</span>
<span class=sd>    Fixture to set up the connection to the temporal database, the path is</span>
<span class=sd>    stablished at conftest.py</span>
<span class=sd>    &#39;&#39;&#39;</span>

    <span class=c1># Create database connection</span>
    <span class=n>connection</span> <span class=o>=</span> <span class=n>engine</span><span class=o>.</span><span class=n>connect</span><span class=p>()</span>

    <span class=c1># Applies all alembic migrations.</span>
    <span class=n>config</span> <span class=o>=</span> <span class=n>Config</span><span class=p>(</span><span class=s1>&#39;{{ program_name }}/migrations/alembic.ini&#39;</span><span class=p>)</span>
    <span class=n>upgrade</span><span class=p>(</span><span class=n>config</span><span class=p>,</span> <span class=s1>&#39;head&#39;</span><span class=p>)</span>

    <span class=c1># End of setUp</span>

    <span class=k>yield</span> <span class=n>connection</span>

    <span class=c1># Start of tearDown</span>
    <span class=n>connection</span><span class=o>.</span><span class=n>close</span><span class=p>()</span>


<span class=nd>@pytest</span><span class=o>.</span><span class=n>fixture</span><span class=p>(</span><span class=n>scope</span><span class=o>=</span><span class=s1>&#39;function&#39;</span><span class=p>)</span>
<span class=k>def</span> <span class=nf>session</span><span class=p>(</span><span class=n>connection</span><span class=p>):</span>
    <span class=sd>&#39;&#39;&#39;</span>
<span class=sd>    Fixture to set up the sqlalchemy session of the database.</span>
<span class=sd>    &#39;&#39;&#39;</span>

    <span class=c1># Begin a non-ORM transaction and bind session</span>
    <span class=n>transaction</span> <span class=o>=</span> <span class=n>connection</span><span class=o>.</span><span class=n>begin</span><span class=p>()</span>
    <span class=n>session</span> <span class=o>=</span> <span class=n>sessionmaker</span><span class=p>()(</span><span class=n>bind</span><span class=o>=</span><span class=n>connection</span><span class=p>)</span>

    <span class=n>factories</span><span class=o>.</span><span class=n>UserFactory</span><span class=o>.</span><span class=n>_meta</span><span class=o>.</span><span class=n>sqlalchemy_session</span> <span class=o>=</span> <span class=n>session</span>

    <span class=k>yield</span> <span class=n>session</span>

    <span class=c1># Close session and rollback transaction</span>
    <span class=n>session</span><span class=o>.</span><span class=n>close</span><span class=p>()</span>
    <span class=n>transaction</span><span class=o>.</span><span class=n>rollback</span><span class=p>()</span>
</code></pre></div> </li> <li> <p>Define an abstract base test class <code>BaseModelTest</code> defined as following in the <code>tests/unit/test_models.py</code> file.</p> </li> </ul> <div class=highlight><pre><span></span><code><span class=kn>from</span> <span class=p>{{</span> <span class=n>program_name</span> <span class=p>}}</span> <span class=kn>import</span> <span class=nn>models</span>
<span class=kn>from</span> <span class=nn>tests</span> <span class=kn>import</span> <span class=n>factories</span>

<span class=kn>import</span> <span class=nn>pytest</span>


<span class=k>class</span> <span class=nc>BaseModelTest</span><span class=p>:</span>
    <span class=sd>&quot;&quot;&quot;</span>
<span class=sd>    Abstract base test class to refactor model tests.</span>

<span class=sd>    The Children classes must define the following attributes:</span>
<span class=sd>        self.model: The model object to test.</span>
<span class=sd>        self.dummy_instance: A factory object of the model to test.</span>
<span class=sd>        self.model_attributes: List of model attributes to test</span>

<span class=sd>    Public attributes:</span>
<span class=sd>        dummy_instance (Factory_boy object): Dummy instance of the model.</span>
<span class=sd>    &quot;&quot;&quot;</span>

    <span class=nd>@pytest</span><span class=o>.</span><span class=n>fixture</span><span class=p>(</span><span class=n>autouse</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
    <span class=k>def</span> <span class=nf>base_setup</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>session</span><span class=p>):</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>session</span> <span class=o>=</span> <span class=n>session</span>

    <span class=k>def</span> <span class=nf>test_attributes_defined</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
        <span class=k>for</span> <span class=n>attribute</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>model_attributes</span><span class=p>:</span>
            <span class=k>assert</span> <span class=nb>getattr</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>model</span><span class=p>,</span> <span class=n>attribute</span><span class=p>)</span> <span class=o>==</span> \
                <span class=nb>getattr</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>dummy_instance</span><span class=p>,</span> <span class=n>attribute</span><span class=p>)</span>


<span class=nd>@pytest</span><span class=o>.</span><span class=n>mark</span><span class=o>.</span><span class=n>usefixtures</span><span class=p>(</span><span class=s1>&#39;base_setup&#39;</span><span class=p>)</span>
<span class=k>class</span> <span class=nc>TestUser</span><span class=p>(</span><span class=n>BaseModelTest</span><span class=p>):</span>

    <span class=nd>@pytest</span><span class=o>.</span><span class=n>fixture</span><span class=p>(</span><span class=n>autouse</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
    <span class=k>def</span> <span class=nf>setup</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>session</span><span class=p>):</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>factory</span> <span class=o>=</span> <span class=n>factories</span><span class=o>.</span><span class=n>UserFactory</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>dummy_instance</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>factory</span><span class=o>.</span><span class=n>create</span><span class=p>()</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>model</span> <span class=o>=</span> <span class=n>models</span><span class=o>.</span><span class=n>User</span><span class=p>(</span>
            <span class=nb>id</span><span class=o>=</span><span class=bp>self</span><span class=o>.</span><span class=n>dummy_instance</span><span class=o>.</span><span class=n>id</span><span class=p>,</span>
            <span class=n>name</span><span class=o>=</span><span class=bp>self</span><span class=o>.</span><span class=n>dummy_instance</span><span class=o>.</span><span class=n>name</span><span class=p>,</span>
        <span class=p>)</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>model_attributes</span> <span class=o>=</span> <span class=p>[</span>
            <span class=s1>&#39;name&#39;</span><span class=p>,</span>
            <span class=s1>&#39;id&#39;</span><span class=p>,</span>
        <span class=p>]</span>
</code></pre></div> <ul> <li>Then <a href=#creating-tables>create the <code>models</code> table</a>.</li> <li><a href=../alembic/#database-migration>Create an alembic revision</a></li> <li>Run <code>pytest</code>: <code>python -m pytest</code>.</li> </ul> <h2 id=exporting-database-to-json><a href=https://stackoverflow.com/questions/47307873/read-entire-database-with-sqlalchemy-and-dump-as-json>Exporting database to json</a><a class=headerlink href=#exporting-database-to-json title="Permanent link">&para;</a></h2> <div class=highlight><pre><span></span><code><span class=kn>import</span> <span class=nn>json</span>

<span class=k>def</span> <span class=nf>dump_sqlalchemy</span><span class=p>(</span><span class=n>output_connection_string</span><span class=p>,</span><span class=n>output_schema</span><span class=p>):</span>
    <span class=sd>&quot;&quot;&quot; Returns the entire content of a database as lists of dicts&quot;&quot;&quot;</span>
    <span class=n>engine</span> <span class=o>=</span> <span class=n>create_engine</span><span class=p>(</span><span class=sa>f</span><span class=s1>&#39;</span><span class=si>{</span><span class=n>output_connection_string</span><span class=si>}{</span><span class=n>output_schema</span><span class=si>}</span><span class=s1>&#39;</span><span class=p>)</span>
    <span class=n>meta</span> <span class=o>=</span> <span class=n>MetaData</span><span class=p>()</span>
    <span class=n>meta</span><span class=o>.</span><span class=n>reflect</span><span class=p>(</span><span class=n>bind</span><span class=o>=</span><span class=n>engine</span><span class=p>)</span>  <span class=c1># http://docs.sqlalchemy.org/en/rel_0_9/core/reflection.html</span>
    <span class=n>result</span> <span class=o>=</span> <span class=p>{}</span>
    <span class=k>for</span> <span class=n>table</span> <span class=ow>in</span> <span class=n>meta</span><span class=o>.</span><span class=n>sorted_tables</span><span class=p>:</span>
        <span class=n>result</span><span class=p>[</span><span class=n>table</span><span class=o>.</span><span class=n>name</span><span class=p>]</span> <span class=o>=</span> <span class=p>[</span><span class=nb>dict</span><span class=p>(</span><span class=n>row</span><span class=p>)</span> <span class=k>for</span> <span class=n>row</span> <span class=ow>in</span> <span class=n>engine</span><span class=o>.</span><span class=n>execute</span><span class=p>(</span><span class=n>table</span><span class=o>.</span><span class=n>select</span><span class=p>())]</span>
    <span class=k>return</span> <span class=n>json</span><span class=o>.</span><span class=n>dumps</span><span class=p>(</span><span class=n>result</span><span class=p>)</span>
</code></pre></div> <h2 id=cloning-an-sqlalchemy-object><a href=https://stackoverflow.com/questions/28871406/how-to-clone-a-sqlalchemy-db-object-with-new-primary-key>Cloning an SQLAlchemy object</a><a class=headerlink href=#cloning-an-sqlalchemy-object title="Permanent link">&para;</a></h2> <p>The following function:</p> <ul> <li>Copies all the non-primary-key columns from the input model to a new model instance.</li> <li>Allows definition of specific arguments.</li> <li>Leaves the original model object unmodified.</li> </ul> <div class=highlight><pre><span></span><code><span class=k>def</span> <span class=nf>clone_model</span><span class=p>(</span><span class=n>model</span><span class=p>,</span> <span class=o>**</span><span class=n>kwargs</span><span class=p>):</span>
    <span class=sd>&quot;&quot;&quot;Clone an arbitrary sqlalchemy model object without its primary key values.&quot;&quot;&quot;</span>

    <span class=n>table</span> <span class=o>=</span> <span class=n>model</span><span class=o>.</span><span class=n>__table__</span>
    <span class=n>non_primary_key_columns</span> <span class=o>=</span> <span class=p>[</span>
        <span class=n>column_name</span>
        <span class=k>for</span> <span class=n>column_name</span> <span class=ow>in</span> <span class=n>table</span><span class=o>.</span><span class=n>__mapper__</span><span class=o>.</span><span class=n>attrs</span><span class=o>..</span><span class=n>keys</span><span class=p>()</span>
        <span class=k>if</span> <span class=n>column_name</span> <span class=ow>not</span> <span class=ow>in</span> <span class=n>table</span><span class=o>.</span><span class=n>primary_key</span>
    <span class=p>]</span>
    <span class=n>data</span> <span class=o>=</span> <span class=p>{</span>
        <span class=n>column_name</span><span class=p>:</span> <span class=nb>getattr</span><span class=p>(</span><span class=n>model</span><span class=p>,</span> <span class=n>column_name</span><span class=p>)</span>
        <span class=k>for</span> <span class=n>column_name</span> <span class=ow>in</span> <span class=n>non_pk_columns</span>
    <span class=p>}</span>
    <span class=n>data</span><span class=o>.</span><span class=n>update</span><span class=p>(</span><span class=n>kwargs</span><span class=p>)</span>

    <span class=k>return</span> <span class=n>model</span><span class=o>.</span><span class=vm>__class__</span><span class=p>(</span><span class=o>**</span><span class=n>data</span><span class=p>)</span>
</code></pre></div> <h2 id=references>References<a class=headerlink href=#references title="Permanent link">&para;</a></h2> <ul> <li><a href=https://www.sqlalchemy.org/ >Home</a></li> <li><a href=https://docs.sqlalchemy.org>Docs</a></li> </ul> <hr> <div class=md-source-date> <small> Last update: <span class=timeago datetime=1591125662000 locale=en></span> </small> </div> </article> </div> </div> </main> <footer class=md-footer> <div class=md-footer-nav> <nav class="md-footer-nav__inner md-grid"> <a href=../ruamel_yaml/ title="Ruamel YAML" class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel=prev> <div class="md-flex__cell md-flex__cell--shrink"> <i class="md-icon md-icon--arrow-back md-footer-nav__button"></i> </div> <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title"> <span class=md-flex__ellipsis> <span class=md-footer-nav__direction> Previous </span> Ruamel YAML </span> </div> </a> <a href=../redis-py/ title=Redis-py class="md-flex md-footer-nav__link md-footer-nav__link--next" rel=next> <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title"> <span class=md-flex__ellipsis> <span class=md-footer-nav__direction> Next </span> Redis-py </span> </div> <div class="md-flex__cell md-flex__cell--shrink"> <i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i> </div> </a> </nav> </div> <div class="md-footer-meta md-typeset"> <div class="md-footer-meta__inner md-grid"> <div class=md-footer-copyright> powered by <a href=https://www.mkdocs.org target=_blank rel=noopener>MkDocs</a> and <a href=https://squidfunk.github.io/mkdocs-material/ target=_blank rel=noopener> Material for MkDocs</a> </div> <div class=md-footer-social> <link rel=stylesheet href=../../../assets/fonts/font-awesome.css> <a href=https://github.com/lyz-code target=_blank rel=noopener title=github class="md-footer-social__link fa fa-github"></a> </div> </div> </div> </footer> </div> <script src=../../../assets/javascripts/application.c33a9706.js></script> <script>app.initialize({version:"1.1",url:{base:"../../.."}})</script> <script src=https://cdnjs.cloudflare.com/ajax/libs/timeago.js/4.0.0-beta.2/timeago.min.js></script> <script src=https://cdnjs.cloudflare.com/ajax/libs/timeago.js/4.0.0-beta.2/timeago.locales.min.js></script> <script>
            const nodes = document.querySelectorAll('.timeago');
            const locale = nodes[0].getAttribute('locale');
            timeago.render(nodes, locale);
          </script> </body> </html>